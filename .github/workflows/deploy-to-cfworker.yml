name: è‡ªåŠ¨éƒ¨ç½²åˆ° CF Worker

on:
    push:
        branches:
            - main
        paths:
            - "src/**"
            - "frontend/**"
            - "wrangler.toml"
    workflow_dispatch:

jobs:
    auto-deploy:
        runs-on: ubuntu-latest
        env:
            PASSWORD: ${{ secrets.PASSWORD }}
            TGID: ${{ secrets.TGID}}
            TGTOKEN: ${{ secrets.TGTOKEN}}
            CF_KV_ID: ${{ secrets.CF_KV_ID }}
            CF_CRONS: ${{ vars.CF_CRONS || '0 1,13 * * *' }}

        steps:
            - name: â¬‡ï¸ æ£€å‡ºä»“åº“
              uses: actions/checkout@v4

            - name: ğŸ› ï¸ å®‰è£… Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: ğŸ†™ æ›´æ–°å¹¶å®‰è£…æœ€æ–° Wrangler
              run: npm install -g wrangler@latest

            - name: ğŸ”„ æ›¿æ¢ wrangler.toml ä¸­çš„å˜é‡
              id: config_setup
              run: |
                  # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶åˆ—è¡¨ï¼Œç”¨äºè°ƒè¯•
                  echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
                  echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨:"
                  ls -la

                  # éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
                  echo "ğŸ” ç¯å¢ƒå˜é‡æ£€æŸ¥:"
                  echo "CF_KV_ID: ${CF_KV_ID:-æœªè®¾ç½®}"
                  echo "CF_ACCOUNT_ID: ${CF_ACCOUNT_ID:-æœªè®¾ç½®}"
                  echo "CF_CRONS: ${CF_CRONS:-æœªè®¾ç½®}"

                  # æ£€æŸ¥ CF_KV_ID æ˜¯å¦è®¾ç½®
                  [ -n "${CF_KV_ID}" ] || { echo "ğŸ”´ é”™è¯¯: å¿…é¡»è®¾ç½® 'CF_KV_ID' å˜é‡"; exit 1; }  

                  # å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
                  cp wrangler.toml wrangler.toml.bak

                  # æ›¿æ¢å˜é‡ï¼Œä½¿ç”¨æ›´å¯é çš„æ›¿æ¢å‘½ä»¤
                  echo "ğŸ”„ æ›¿æ¢ wrangler.toml ä¸­çš„å˜é‡..."
                  sed -i "s/{CF_KV_ID}/${CF_KV_ID}/g" wrangler.toml
                  sed -i "s/{CF_CRONS}/${CF_CRONS}/g" wrangler.toml

                  # éªŒè¯æ›¿æ¢ç»“æœ
                  echo "âœ… æ›¿æ¢å®Œæˆï¼ŒéªŒè¯ç»“æœ:"
                  echo "-------------------"
                  cat wrangler.toml
                  echo "-------------------"

                  # æ£€æŸ¥æ›¿æ¢æ˜¯å¦æˆåŠŸ
                  if grep -q "{CF_KV_ID}" wrangler.toml; then
                    echo "ğŸ”´ é”™è¯¯: CF_KV_ID æ›¿æ¢å¤±è´¥ï¼Œä»å­˜åœ¨å ä½ç¬¦"
                    exit 1
                  fi

                  if grep -q "{CF_CRONS}" wrangler.toml; then
                    echo "ğŸ”´ é”™è¯¯: CF_CRONS æ›¿æ¢å¤±è´¥ï¼Œä»å­˜åœ¨å ä½ç¬¦"
                    exit 1
                  fi

                  # æå– Worker åç§°
                  WORKER_NAME=$(grep '^name =' wrangler.toml | awk -F '"' '{print $2}')
                  [ -n "$WORKER_NAME" ] || { echo "ğŸ”´ é”™è¯¯: æœªèƒ½åœ¨ wrangler.toml ä¸­æ‰¾åˆ° 'name' å­—æ®µ"; exit 1; }

                  echo "worker_name=$WORKER_NAME" >> $GITHUB_OUTPUT

            - name: âš™ï¸ åŠ¨æ€é…ç½® Worker ç¯å¢ƒå˜é‡
        id: dynamic_vars
        run: |
          VARS=""
          [ -n "$PASSWORD" ] && VARS+="PASSWORD"$'\n' || echo "âš ï¸ è­¦å‘Š: PASSWORD å˜é‡æœªè®¾ç½®ï¼Œé»˜è®¤ä¸º 123123"
          [ -n "$TGID" ] && [ -n "$TGTOKEN" ] && VARS+="TGID"$'\n'"TGTOKEN"$'\n' || echo "âš ï¸ è­¦å‘Š: TG å˜é‡æœªè®¾ç½®ï¼Œæ— æ³•æ‰§è¡Œ TG é€šçŸ¥"
          
          # åªè¾“å‡ºä¸€æ¬¡å˜é‡åˆ—è¡¨åˆ° GITHUB_OUTPUT
          printf 'vars_list<<EOF\n%sEOF\n' "$VARS" >>"$GITHUB_OUTPUT"

          if [ -n "$VARS" ]; then
            echo -e "\nâœ… ä¼ é€’ç»™ Wrangler çš„ç¯å¢ƒå˜é‡å:"
            printf '%s' "$VARS"
          else
            echo -e "\nâš ï¸ æ²¡æœ‰éœ€è¦ä¼ é€’çš„å˜é‡å"
          fi

      - name: ğŸ§ª éƒ¨ç½²å‰é…ç½®éªŒè¯
        id: pre_deploy_check
        run: |
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²å‰é…ç½®éªŒè¯..."
          
          # æ£€æŸ¥ wrangler.toml æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "wrangler.toml" ]; then
            echo "ğŸ”´ é”™è¯¯: wrangler.toml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªæ›¿æ¢çš„å ä½ç¬¦
          if grep -q "{.*}" wrangler.toml; then
            echo "ğŸ”´ é”™è¯¯: wrangler.toml ä¸­ä»å­˜åœ¨æœªæ›¿æ¢çš„å ä½ç¬¦:"
            grep -n "{.*}" wrangler.toml
            exit 1
          fi
          
          # æ£€æŸ¥ KV å‘½åç©ºé—´é…ç½®
          if ! grep -q "kv_namespaces" wrangler.toml; then
            echo "ğŸ”´ é”™è¯¯: wrangler.toml ä¸­æœªé…ç½® kv_namespaces"
            exit 1
          fi
          
          # æ£€æŸ¥ KV å‘½åç©ºé—´ ID æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºï¼‰
          KV_ID=$(grep -A 2 "kv_namespaces" wrangler.toml | grep "id =" | awk -F '"' '{print $2}')
          if [ -z "$KV_ID" ]; then
            echo "ğŸ”´ é”™è¯¯: KV å‘½åç©ºé—´ ID ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… éƒ¨ç½²å‰é…ç½®éªŒè¯é€šè¿‡"
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT

      - name: ğŸš€ éƒ¨ç½²åˆ° CF Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ vars.CF_ACCOUNT_ID }}
          vars: ${{ steps.dynamic_vars.outputs.vars_list }}
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ wrangler.toml æ–‡ä»¶
          workingDirectory: .

      - name: âœ¨ è¾“å‡º Worker ç®¡ç†åå°
        env:
          WORKER_NAME: ${{ steps.config_setup.outputs.worker_name }}
          ACCOUNT_ID: ${{ vars.CF_ACCOUNT_ID }}
        run: |
          echo -e "\nâœ¨âœ¨âœ¨ éƒ¨ç½²å®Œæˆ âœ¨âœ¨âœ¨"
          echo "ğŸŒ ç‚¹å‡»ä»¥ä¸‹é“¾æ¥å¯è®¿é—®é¡¹ç›®ç®¡ç†åå°"
          echo "https://dash.cloudflare.com/${ACCOUNT_ID}/workers/services/view/${WORKER_NAME}/production/settings"
          echo "ğŸš€ å»ºè®®: ç»™é¡¹ç›®ç»‘å®šä¸€ä¸ªè‡ªå®šä¹‰åŸŸå"
